<!doctype html>
<html lang="en">
	<head>
	    <!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Arkham Editor</title>

		<!-- Bootstrap CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
		<link rel="stylesheet" href="fonts/arkhamicons.css"></link>
		<style>
		#source{
			display:block;
			width: 100%;
			min-height: 150px;
		}
		
		#result, #md{
			display:block;
			width: 100%;
			min-height: 150px;
			font-family: monospace;
		}
		#md p { white-space: pre-line;}
		.btn-bar{ padding: 0.5rem; }
		.btn[class^="arkhamicons"]{ font-size: 1.1rem; }
		.text-center{ text-align: center; }

		.trait{ font-weight:bold; font-style: italic; }
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col">
					<div class="btn-group insertButtons m-1" role="group">
						<button type="button" class="btn btn-outline-dark arkhamiconsskull" data-insert="[skull]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconscultist" data-insert="[cultist]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconstablet" data-insert="[tablet]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconselder_thing" data-insert="[elder_thing]"></button>
					</div>
					<div class="btn-group insertButtons m-1" role="group">
						<button type="button" class="btn btn-outline-dark arkhamiconselder_sign" data-insert="[elder_sign]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsauto_fail" data-insert="[auto_fail]"></button>
					</div>
					<div class="btn-group insertButtons m-1" role="group">
						<button type="button" class="btn btn-outline-dark arkhamiconscurse" data-insert="[curse]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsbless" data-insert="[bless]"></button>
					</div>
					<div class="btn-group insertButtons m-1" role="group">
						<button type="button" class="btn btn-outline-dark arkhamiconsguardian" data-insert="[guardian]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsseeker" data-insert="[seeker]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsmystic" data-insert="[mystic]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsrogue" data-insert="[rogue]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconssurvivor" data-insert="[survivor]"></button>
					</div>
					<div class="btn-group insertButtons m-1" role="group">
						<button type="button" class="btn btn-outline-dark arkhamiconswillpower" data-insert="[willpower]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsintellect" data-insert="[intellect]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconscombat" data-insert="[combat]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsagility" data-insert="[agility]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconswild" data-insert="[wild]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsneutral" data-insert="[neutral]"></button>
					</div>
					<div class="btn-group insertButtons m-1" role="group">
						<button type="button" class="btn btn-outline-dark arkhamiconsper_investigator" data-insert="[per_investigator]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsaction" data-insert="[action]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsreaction" data-insert="[reaction]"></button>
						<button type="button" class="btn btn-outline-dark arkhamiconsfree" data-insert="[free]"></button>
					</div>
					<div class="btn-group insertButtons m-1" role="group">
						<button type="button" class="btn btn-outline-dark btn-sm" data-insert="&hellip;">&hellip;</button>
						<button type="button" class="btn btn-outline-dark btn-sm" data-wrap="“$”" style="font-weight:bold;">“”</button>
						<button type="button" class="btn btn-outline-dark btn-sm" data-wrap="<u>$</u>" style="text-decoration: underline;">u</button>
						<button type="button" class="btn btn-outline-dark btn-sm" data-wrap="<b>$</b>" style="font-weight:bold;" accesskey="b">B</button>
						<button type="button" class="btn btn-outline-dark btn-sm" data-wrap="<i>$</i>" style="font-style: italic">I</button>
						<button type="button" class="btn btn-outline-dark btn-sm trait" data-wrap="[[$]]" accesskey="t">trait</button>
						<button type="button" class="btn btn-outline-dark btn-sm" data-insert="<b>(→Rx)</b>." style="font-weight:bold;">(→Rx).</button>
					</div>
					<button  type="button" class="btn btn-outline-dark btn-sm"  id="btnFixSpaces" title="fix spaces"><i class="bi bi-card-text"></i></button>				
					<textarea id="source"></textarea>
				</div>
				<div class="col align-self-end">
					<button type="button" class="btn btn-dark btn-sm  m-1" id="btnCopy" title="Copy to clipboard"><i class="bi bi-clipboard"></i></button>
					<textarea id="result"></textarea>
				</div>
			</div>
			<div class="row">
				<div class="col p-2">
					<div id="md"></div>
				</div>
			</div>
		</div>
		
		<script src="https://code.jquery.com/jquery-3.6.1.slim.min.js" integrity="sha256-w8CvhFs7iHNVUtnSP0YKEg00p9Ih13rlL9zGqvLdePA=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<script>
			const tags = ["curse","bless", "skull", "cultist", "tablet", "elder_thing", "elder_sign", "auto_fail", "guardian", "seeker", "mystic", "rogue", "survivor", "willpower", "intellect", "combat", "agility", "neutral", "wild", "per_investigator", "action", "reaction", "free"];
		
			jQuery(()=>{
				const onSourceChange = (evt)=>{
					rewriteText(evt.target.value);
				};
				
				const onResultChange = (evt)=>{
					decode(evt.target.value);
				};

				const rewriteText = (txt) => {
					// tries to fix some common formats
					txt = txt
					.replace(/\uF252/g, '[intellect]')
					.replace(/\uF263/g, '[per_investigator]')
					.replace(/\uF26D/g, '[reaction]')
					.replace(/\uF25A/g, '[free]')
					.replace(/\uF254/g, '[rogue]')
					.replace(/\uF255/g, '[survivor]')
					.replace(/\uF256/g, '[guardian]')
					.replace(/\uF257/g, '[mystic]')
					.replace(/\uF258/g, '[seeker]')
					.replace(/\uF259/g, '[action]')
					.replace(/^=/gm, '-')
					.replace(/\.\.\./g, '\u2026');

					const result = txt
					.replace(/\r?\n/g, '\\n')
					.replace(/"/g, '\\"');
					$result.val( result );

					preview(txt);
				}

				const decode = ( json ) => {
					const txt = json.replaceAll('\\n','\n').replaceAll('\\"','"');
					$source.val( txt );

					preview(txt);
				}

				const preview = (source) => {
					let markdown = source.replace(/\[\[([a-zA-Z ]+)\]\]/g, `<span class="trait">$1</span>`);
					tags.forEach( tag => {
						markdown = markdown.replaceAll( `[${tag}]`, `<span class="arkhamicons${tag}"></span>` );
					});

					$md.html( marked.parse( markdown ) );
				}

				const onFixSpacesClick = ()=>{
					const sourceTXT = $source.val( )
						// remove line break between two lower case letters
						.replace(/\r?\n *(?=[a-z])/g, ' ');

					$source.val( sourceTXT );
					rewriteText(sourceTXT);
				}
				
				const onSourcePaste = (evt)=>{
					setTimeout(onFixSpacesClick, 10);
					//evt.preventDefault();

					//let pasted = evt.originalEvent.clipboardData.getData('Text');
					//txt = pasted.replace(/\r?\n *(?=[a-z])/g, ' ');
					//$source.val( txt );
					//rewriteText(txt);
					//evt.target.value = txt;
					// FIXME
					//setTimeout(()=>{ $source.val( txt ) }, 10);
				}
				
				
				const onCopyClick = () => {
					const elem = $result.get(0);
				  // create hidden text element, if it doesn't already exist
					var targetId = "_hiddenCopyText_";
					var isInput = elem.tagName === "INPUT" || elem.tagName === "TEXTAREA";
					var origSelectionStart, origSelectionEnd;
					if (isInput) {
						// can just use the original source element for the selection and copy
						target = elem;
						origSelectionStart = elem.selectionStart;
						origSelectionEnd = elem.selectionEnd;
					} else {
						// must use a temporary form element for the selection and copy
						target = document.getElementById(targetId);
						if (!target) {
							var target = document.createElement("textarea");
							target.style.position = "absolute";
							target.style.left = "-9999px";
							target.style.top = "0";
							target.id = targetId;
							document.body.appendChild(target);
						}
						target.textContent = elem.textContent;
					}
					// select the content
					var currentFocus = document.activeElement;
					target.focus();
					target.setSelectionRange(0, target.value.length);
					
					// copy the selection
					var succeed;
					try {
						  succeed = document.execCommand("copy");
					} catch(e) {
						succeed = false;
					}
					// restore original focus
					if (currentFocus && typeof currentFocus.focus === "function") {
						currentFocus.focus();
					}
					
					if (isInput) {
						// restore prior selection
						elem.setSelectionRange(origSelectionStart, origSelectionEnd);
					} else {
						// clear temporary content
						target.textContent = "";
					}
					return succeed;
				}
				
				const insertAtCursor = (myField, myValue)=>{
					//IE support
					if (document.selection) {
						myField.focus();
						sel = document.selection.createRange();
						sel.text = myValue;
					}
					//MOZILLA and others
					else if (myField.selectionStart || myField.selectionStart == '0') {
						var startPos = myField.selectionStart;
						var endPos = myField.selectionEnd;
						myField.value = myField.value.substring(0, startPos)
							+ myValue
							+ myField.value.substring(endPos, myField.value.length);
					} else {
						myField.value += myValue;
					}
				}
				
				const wrapAtCursor = (myField, prefix, suffix)=>{
					//IE support
					if (document.selection) {
						myField.focus();
						sel = document.selection.createRange();
						sel.text = prefix + sel.text + suffix;
					}
					//MOZILLA and others
					else if (myField.selectionStart || myField.selectionStart == '0') {
						var startPos = myField.selectionStart;
						var endPos = myField.selectionEnd;
						
						const before = myField.value.substring(0, startPos);
						const after = myField.value.substring(endPos, myField.value.length);
						const middle = myField.value.substring(startPos, endPos);
						myField.value = before + prefix + middle + suffix + after;
					} else {
						myField.value += prefix + suffix;
					}
				}
				
				const onInsertButtonClick = (evt)=>{
					const value = $(evt.target).attr('data-insert');
					insertAtCursor( $source.get(0), value);
					rewriteText( $source.val() );
					$source.focus();
				}

				const onWrapButtonClick = (evt)=>{
					const value = $(evt.target).attr('data-wrap');
					const tokens = value.split('$');
					wrapAtCursor( $source.get(0), tokens[0], tokens[1]);
					rewriteText( $source.val() );
					$source.focus();
				}
				

				$('.insertButtons button[data-insert]').click( onInsertButtonClick );
				$('.insertButtons button[data-wrap]').click( onWrapButtonClick );
				
				const $source = $('#source');
				const $result = $('#result');
				const $md = $('#md');
				const $btnCopy = $('#btnCopy');
				const $btnFixSpaces = $('#btnFixSpaces');

				$result.bind('input propertychange', onResultChange);
				$source.bind('input propertychange', onSourceChange);
				$source.bind('paste', onSourcePaste);
				$btnCopy.bind('click', onCopyClick);
				$btnFixSpaces.bind('click', onFixSpacesClick);
			});
		</script>
	</body>
</html>